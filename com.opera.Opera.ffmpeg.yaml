app-id: com.opera.Opera.ffmpeg
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
base: org.chromium.Chromium.BaseApp
base-version: '22.08'

_build_flags:
  - 'is_component_build=false'
  - 'is_component_ffmpeg=true'
  - 'use_sysroot=false'
  - 'use_qt=false'
  - 'use_glib=false'
  - 'ozone_platform_x11=false'

_ffmpeg_build_flags:
  - "ffmpeg_branding=\"ChromeOS\""
  - "proprietary_codecs=true"
  - "enable_platform_hevc=true"
  - "enable_platform_ac3_eac3_audio=true"
  - "enable_platform_mpeg_h_audio=true"
  - "enable_platform_dolby_vision=true"
  - "enable_mse_mpeg2ts_stream_parser=true"


modules:
  - name: opera-ffmpeg
    buildsystem: simple 
    # buildsystem: cmake-ninja
    build-commands:
      - mkdir -p /app/opera-ffmpeg
      - cd chromium
      - python tools/clang/scripts/update.py
      - python tools/rust/update_rust.py
      - export PATH="${pwd}/third_party/llvm-build/Release+Asserts/bin:$PATH"
      - export CC="clang"
      - export CXX="clang++"
      - gn gen -v --fail-on-unused-args --args="${_build_flags[*]} ${_ffmpeg_build_flags[*]}" --script-executable=/usr/bin/python out/ffmpegso
      - ninja -C out/ffmpegso libffmpeg.so
    sources:
      - type: archive
        url: https://commondatastorage.googleapis.com/chromium-browser-official/chromium-120.0.6099.109.tar.xz
        sha256: 87c00c525ee07c2233b78dbece1496b697f686244a67fac2c71e4a30bd96849b 
        dest-filename: chromium.tar.xz
        only-arches: [x86_64]